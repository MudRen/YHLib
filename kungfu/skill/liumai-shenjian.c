#include <ansi.h>
inherit SKILL;

mapping *action = ({
([      "name":   "少商剑",
	"action": "$N双手拇指同时捺出，嗤嗤两声急响，「" HIW "少商剑" NOR "」有如石破"
                  "天惊、风雨大至",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少商剑",
        "action": "$N大拇指一按，嗤嗤两指，劲道使得甚巧，「" HIW "少商剑" NOR "」剑气"
                  "如怒潮般涌至",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少商剑",
        "action": "$N大拇指连挥，「" HIW "少商剑" NOR "」便如是一幅泼墨山水，纵横倚斜"
                  "，剑路雄劲",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少商剑",
        "action": "$N双手拇指同时捺出，「" HIW "少商剑" NOR "」大开大阖，气派宏伟，每"
                  "一剑都有风雨大至之势",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "商阳剑",
        "action": "$N食指连动，手腕园转，「" HIW "商阳剑" NOR "」一剑又一剑的刺出，轻"
                  "灵迅速，剑气纵横",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商阳剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "商阳剑",
        "action": "$N变招奇速，右手食指疾从袖底穿出，「" HIW "商阳剑" NOR "」登时幻出"
                  "无数指影",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商阳剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "商阳剑",
        "action": "$N拇指一屈，食指随即点出，嗤嗤两声急响，变成商阳剑法，「" HIW "商"
                  "阳剑" NOR "」激射刺出",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商阳剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "商阳剑",
        "action": "$N以食指急运「" HIW "商阳剑" NOR "」之无形剑气，却不过是手指在数寸"
                  "范围内一点一戳",
        "force" : 480,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商阳剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "中冲剑",
        "action": "$N右手中指一竖，「" HIW "中冲剑" NOR "」向前刺出。真气鼓荡，嗤然声"
                  "响，无形剑气直指$n",
        "force" : 560,
        "attack": 155,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "中冲剑",
        "action": "$N将中指向上一刺，「" HIW "中冲剑" NOR "」拔地而起，接着手指向下一"
                  "划，剑气如利刀般砍出",
        "force" : 560,
        "attack": 145,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "中冲剑",
        "action": "电光火石之间，$N猛然翻掌，右手陡然探出，中指「" HIW "中冲剑" NOR
                  "」向$n一竖",
        "force" : 560,
        "attack": 135,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "关冲剑",
        "action": "$N右手无名指伸出，「" HIW "关冲剑" NOR "」剑路拙滞古朴，一股雄浑无"
                  "比的内力鼓荡而出",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "关冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "关冲剑",
        "action": "$N俯身斜倚，无名指「" HIW "关冲剑" NOR "」弹射而出，指尖已对准$n发"
                  "出了一缕强烈的劲风",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "关冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "关冲剑",
        "action": "$N无名指轻轻一挥，「嗤啦」一声，拙滞古朴的「" HIW "关冲剑" NOR "」"
                  "剑气向$n直射而出",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "关冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少泽剑",
        "action": "$N左手小指一伸，一条气流从少冲穴中激射而出，「" HIW "少泽剑" NOR
                  "」出手入风，指向$n",
        "force" : 500,
        "attack": 160,
        "dodge" : 95,
        "parry" : 92,
        "damage": 270,
        "weapon" : HIW "少泽剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少泽剑",
        "action": "忽见$N左手小指一伸，一条气流从$P少冲穴中激射而出，一股「" HIW "少"
                  "泽剑" NOR "」登时射向$n",
        "force" : 500,
        "attack": 160,
        "dodge" : 95,
        "parry" : 92,
        "damage": 270,
        "weapon" : HIW "少泽剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少冲剑",
        "action": "$N右手小指伸出，真气自少冲穴激荡而出，「" HIW "少冲剑" NOR "」横生"
                  "奇变，飕的刺向$n",
        "force" : 480,
        "attack": 150,
        "dodge" : 90,
        "parry" : 95,
        "damage": 240,
        "weapon" : HIW "少冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少冲剑",
        "action": "$N掌托于胸前，伸出右小指，一招「" HIW "少冲剑" NOR "」缓缓地点向$n"
                  "的周身大穴",
        "force" : 530,
        "attack": 170,
        "dodge" : 90,
        "parry" : 95,
        "damage": 260,
        "weapon" : HIW "少冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少冲剑",
        "action": "$N小指一弹，「" HIW "少冲剑" NOR "」化式「分花拂柳」，剑势如同柳絮"
                  "一般，飘而不乱",
        "force" : 430,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "少冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少冲剑",
        "action": "$N一招「" HIW "少冲剑" NOR "」，剑气回转无定形，竟从左侧绕了过来，"
                  "点向$n",
        "force" : 530,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 240,
        "weapon" : HIW "少冲剑气" NOR,
        "damage_type":  "刺伤"
]),
([      "name":   "少冲剑",
        "action": "$N右手小指一挥，一招「" HIW "少冲剑" NOR "」点点刺刺破空刺出，宛如"
                  "雕花刺画一般",
        "force" : 530,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "少冲剑气" NOR,
        "damage_type":  "刺伤"
]),
});

string main_skill()
{
	return "liumai-shenjian";
}

mapping sub_skills = ([
        "shaoshang-sword"  : 180,
        "shangyang-sword"  : 180,
        "zhongchong-sword" : 180,
        "guanchong-sword"  : 180,
        "shaoze-sword"     : 180,
        "shaochong-sword"  : 180,
]);

int get_ready(object me)
{
        return 1;
}

int get_finish(object me)
{
        if (me->query("int") < 36)
        {
                tell_object(me, "你演练完毕，只感六种剑法毫无牵连，看来依你的悟性，无"
                                "法将其合一。\n");
                return 0;
        }

        if (me->query("con") < 36)
        {
                tell_object(me, "你演练完毕，只觉全身真气乱窜，眼冒金星，两耳轰鸣，好"
                                "不容易才控制下来。\n");
                return 0;
        }

        if (me->query("gender") == "无性")
                return notify_fail("你无根无性，阴阳不调，难以演练六脉神剑。\n");

        if (me->query_skill("literate", 1) < 200)
        {
                tell_object(me, "你觉得六脉神剑极其深奥，看来多研究一下学问可能更有帮"
                                "助。\n");
                return 0;
        }

        if (me->query_skill("lamaism", 1) < 200)
        {
                tell_object(me, "你演练完毕，发现如果通晓密宗心法应该更有帮助。\n");
                return 0;
        }

        if (me->query_skill("buddhism", 1) < 200)
        {
                tell_object(me, "你演练完毕，发现如果通晓禅宗心法应该更有帮助。\n");
                return 0;
        }

        if (me->query_skill("jingluo-xue", 1) < 200)
        {
                tell_object(me, "你演练完毕，发现如果通晓经络学应该更有所帮助。\n");
                return 0;
        }

        if ((int)me->query("max_neili") < 5000)
        {
                tell_object(me, "你觉得真气不继，无法融会贯通六剑。\n");
                return 0;
        }
   
        if ((int)me->query_skill("martial-cognize", 1) < 200)
        {
                tell_object(me, "你演练完毕，发现如果武学修养更上一层因该更有所帮助。\n");
                return 0;           
        }

        if ((int)me->query_skill("force", 1) < 340)
        {
                tell_object(me, "你演练完毕，发现自己内功根基太差，无法再继续演练下去。\n");
                return 0;           
        }

        if (random(10) < 7)
        {
                tell_object(me, "你觉得有所感悟，或许再演练一次就能融会贯通，练成六脉"
                                "神剑。\n");
                return 0;
        }

        tell_object(me, HIY "一阵凡尘往事涌上心头，你几欲放声长叹。眼前不断闪现出六脉"
                            "剑法，\n霎那间，你终于通晓六脉神剑。\n" NOR);
        return 1;
}

mapping query_sub_skills()
{
        return sub_skills;
}

int valid_enable(string usage)
{
	return usage == "finger" || usage == "parry";
}

int double_attack()
{
	return 1;
}

int valid_learn(object me)
{
        if (me->query_temp("weapon") || me->query_temp("secondary_weapon"))
                return notify_fail("练六脉神剑必须空手。\n");

        if (me->query("int") < 36)
                return notify_fail("你研究了半天，只感六种剑法毫无牵连，无法再作研究。\n");

        if (me->query("con") < 36)
                return notify_fail("你研究了一会儿，只觉得眼前金星乱冒，太阳穴突突的跳。\n");

        if (me->query_skill("literate", 1) < 200)
                return notify_fail("你觉得六脉神剑极其深奥，不是你这种学问水平所能研究的。\n");

        if (me->query_skill("lamaism", 1) < 200)
                return notify_fail("你发现这里面有很多奥妙都和密宗心法有关，难以理解。\n");

        if (me->query_skill("buddhism", 1) < 200)
                return notify_fail("你发现这里面有很多奥妙都和禅宗心法有关，难以理解。\n");

        if (me->query_skill("jingluo-xue", 1) < 200)
                return notify_fail("你发现这里面有很多奥妙都和人体的经络构造有关，难以理解。\n");

        if ((int)me->query("max_neili") < 5000)
                return notify_fail("你的内力太弱，无法学六脉神剑。\n");

        if ((int)me->query_skill("finger", 1) < 200)
                return notify_fail("你的基本指法火候不够。\n");

        if ((int)me->query_skill("force", 1) < (int)me->query_skill("liumai-shenjian", 1) + 10)
                return notify_fail("你的现在必须先提高你基本内功的水平。\n");

        if ((int)me->query_skill("finger", 1) < (int)me->query_skill("liumai-shenjian", 1) + 10)
                return notify_fail("你的现在必须先提高你基本指法的水平。\n");

        return 1;
}

string query_skill_name(int level)
{
        int i;
        for(i = sizeof(action); i > 0; i--)
                if(level >= action[i-1]["lvl"])
                        return action[i-1]["skill_name"];
}

int practice_skill(object me)
{
        int cost;

        if ((int)me->query("qi") < 100)
                return notify_fail("你的体力太低了。\n");

        cost = me->query_skill("liumai-shenjian", 1) / 2 + 160;

        if ((int)me->query("neili") < cost)
                return notify_fail("你的内力不够练六脉神剑。\n");

        me->receive_damage("qi", 88);
        me->add("neili", -cost);
        return 1;
}

mixed hit_ob(object me, object victim, int damage_bonus, int i, int attack_time)
{
        string name;

        if (userp(me))
        	attack_time = (int)(me->query_skill("liumai-shenjian", 1) / 50);
	else
        	attack_time = (int)(me->query_skill("liumai-shenjian", 1) / 25);

        // 放宽NPC的攻击力度
        if (userp(me) && attack_time > 6)
                attack_time = 6;

        if (! me->is_busy()
           && living(victim)
           && damage_bonus > 120
           && me->query("neili") > 400
           && me->query_temp("action_flag") != 0
           && me->query_skill("martial-cognize", 1) >= 220
           && me->query_skill("liumai-shenjian", 1) >= 180
           && me->query_skill("jingluo-xue", 1) >= 200)
	{
	        if (userp(me) && random(3) != 1)
			        return 0;

        	// 避免在使用Pfm时讯息重复
        	if (userp(me) && ! me->query_temp("liumai-shenjian/hit_msg"))
                	message_vision(HIW "\n霎时间$N" HIW "只觉思绪狂涌，六脉剑谱中"
                                       "的六路剑法交替展现，登时十指纷弹，此去彼来，连"
                                       "绵无尽。\n" NOR, me, victim);

	        if (userp(me))
	        	me->start_busy(2 + random(attack_time));
		    else
	        	me->start_busy(1);

       		me->add("neili", -attack_time * 50);

        	for (i = 0; i < attack_time; i++)
        	{
                	if (! me->is_fighting(victim))
                        	break;
                	COMBAT_D->do_attack(me, victim, 0, 0);
        	}
	}

           if (damage_bonus / 5 > victim->query_dex()
	       && damage_bonus > 150
           && me->query("neili") > 200
           && me->query_skill("martial-cognize", 1) >= 220
           && me->query_skill("liumai-shenjian", 1) >= 160
           && me->query_skill("jingluo-xue", 1) >= 180)
        {
                me->add("neili", -50);
                victim->receive_wound("qi", (damage_bonus - 80) / 2, me);
                return random(2) ? HIR "你听到「嗤啦」一声轻响，脸上竟飞溅到了一些血滴"
                                   "！\n" NOR:

                                   HIR "你只听「噗嗤」一声轻响，一股血柱至$n" HIR "身上"
                                   "溅出！\n" NOR;
        }
        return 1;
}

mapping query_action(object me, object weapon)
{
        if (! undefinedp(me->query_temp("six-action")))
                return action[me->query_temp("six-action")];

        if (random(15) == 1 && me->query("neili") > 600)
        {
                me->add("neili", -300);
                return ([       "action": "$N纵身前扑，双手拇指同时按出一记「" HIR "少商剑" NOR
                                          "」，两道无形剑气破空而出逼向$n",
        		                "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破体无形剑气" NOR,
                                "damage_type": "刺伤"
		        ]);
        } else
        if (random(15) == 1 && me->query("neili") > 600)
        {
                me->add("neili", -300);
                return ([       "action": "$N双手手指急速弹动，顿时「" HIR "商阳剑" NOR "」和「"
                                          HIR "中冲剑" NOR "」两路剑法齐施，剑气源源不断涌向$n",
        		                "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破体无形剑气" NOR,
                                "damage_type": "刺伤"
		        ]);
        } else
        if (random(15) == 1 && me->query("neili") > 1000)
        {
                me->add("neili", -300);
                return ([       "action": "$N内息急转，不断催动真气，「" HIR "六脉神剑" NOR "」"
                                          "奥妙无方，剑气破空之声骤响，尽数袭向$n",
        		                "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破体无形剑气" NOR,
                                "damage_type": "刺伤"
		        ]);
        }
        return action[random(sizeof(action))];
}

string query_parry_msg(object victim_weapon)
{
        switch (random(4))
        {
        case 0:
                return "$n随意挥洒，道道剑气纵横交错，宛若天网，$N唯有望洋兴叹，徒呼奈何。\n";
        case 1:
                return "$n不闪不避，一招中冲剑直袭$N的胸前大穴，迫得$N只有回身自救。\n";
        case 2:
                return "$n六剑连出，剑气回荡，直割得$N眉毛削落，脸面生通，再也不能前进半分！\n";
        default:
                return "$n一声长笑，无形剑气四处散开，将$N层层裹住，惟有勉强支撑。才约略摆脱了$n的反击。\n";
        }
}

void skill_improved(object me)
{
        int i;
        string *sub_skillnames;

        sub_skillnames = keys(sub_skills);

        for (i = 0; i < sizeof(sub_skillnames); i++)
                me->delete_skill(sub_skillnames[i]);
}

string perform_action_file(string action)
{
        return __DIR__"liumai-shenjian/" + action; 
}
